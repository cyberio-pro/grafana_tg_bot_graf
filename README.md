### Бот для отправки скриншотов из графаны в телеграм.
#### First - 1 

- В grafane в настройках заводим ключ API

- Сперва вводим понятное нам имя ключа, его лучше сделать таким, чтобы было в дальнейшем не оказалось что, нафиг он нужен и случайно его потом не грохнуть =), роль оставляем Viewer, чтобы этим ключом нельзя было ничего испортить. Название ключа чисто номинальное, на доступы не влияет.

- самую верхнюю строчку […многа-буков…MX0=] надо сразу же, прямо с этого окна, скопировать и разместить в файле настроек нашей сторонней системы, именно это и есть наш ключ доступа. Потом его просто так будет не посмотреть, внутри системы он в открытом виде скорее всего не хранится, потребуется его генерация и перепрописывание заново. И конечно же не забываем про безопасность и не раскидываемся им где попало направо и налево.

- Нажимаем View, чтобы получить этот же график отдельно от остальных (Grafana умеет рендерить и панельки целиком с несколькими графиками сразу, если это требуется). На открывшемся во всю страницу графике снова щелкаем по заголовку и нажимаем Share.

В появившемся окне щелкаем во вкладке [Link] ссылочку [Direct Link rendered Image] 

- Файл получается простым и легковесным. Путь копируем из адресной строки браузера. То, какой именно PNG будет выдан, определяется параметрами запроса. Ключевые данные вот такие:



http://grafana-crm.hq.bc:3000/render/d-solo/000000001/siebel-logs-update-agreement?refresh=1m&orgId=1&panelId=1&from=1546466011827&to=1546487611827&width=1000&height=500&tz=Asia%2FAlmaty



«/render/d-solo/000000001» -  указывает, что будет отдана PNG, а не HTML+JS апплет с наворотами типа зума/измерителя пиков и прочего, причем отдан будет только один график.
«siebel-logs-update-agreement?refresh=1m&orgId=1&panelId=1» -  имя панели и номер конкретного графика с этой панели, время обновления.
«&width=1000&height=500» -  размеры файла. Нефиг заниматься ресайзом в сторонней системе, Grafana это сделает сама, быстрее и лучше. Она же может быть источником картинок разного размера. Не нужно париться с графическими редакторами, подгоняя размеры. 
«&from=1546466011827&to=1546487611827»  - задают начальные и конечные интервалы времени. Это по сути UnixTime-ы, выраженные в миллисекундах, так что не забываем перед вызовом умножать на тысячу, иначе графики будут пустые.
«&tz=Asia%2FAlmaty»  - временная зона 
Собственно это всё  -  для получения картинки с графиком достаточно уметь отправлять GET-запрос с параметрами и одним дополнительным заголовком. Такую штуку несложно сделать на любом языке программирования, где есть более-менее нормальная работа с http. В принципе, поскольку протокол HTTP-текстовый, не сильно сложнее сделать иное и там, где есть только работа с сетевыми сокетами. И никаких шаманств с кукисами, джава-скритами, фреймворками, сторонними кривыми компонентами и непотребными регулярными выражениями!


#### Начало работы - 2

**Склонируйте репозиторий:** 
https://github.com/raptor72/GrafanaScreen-TlgBot

Для рендеринга картинок по API графаны необходимо сгенерировать ключ.
Поместите его в **config.py** в место **grafana_token**.

Если для доступа в телеграм будет использоваться прокси, укажите его в **apihelper_proxy**.
Если вы не используете прокси, закомментируйте строку 15 в **main.py**:

    apihelper.proxy = apihelper_proxy

Укажите **image_path**. Это папка в которую будут загружаться скриншоты из графаны.
Пользователь, под которыйм будет запущен скрипт должен иметь права на эту папку.

Ссылка на используемую графану:

    grafana_url

Токен телеграм бота:

    bot_token

Cпискок пользователей, которые смогут использовать бот:

    user_list

Если использование бота не нужно ограничивать списком пользователей, 
то поменятйте опцию: 

    check = 0

Cписок комманд, которые понимает бот: 

    command_list

Данный список содержит названия дашбордов и графиков. В примере используются два дашборда **bot-testing-dashboard** и **open-dashboard**.
Они включают в  себя по 2 графика: **Carbon - agents localdomain**, **Metric recieved** и **Commited points** и **MemUssage**.

Названия дашбордов в **command_list** необходимо внести так как они называются. Названия графиков можно задать произвольно,
но необходимо указать корректный **panelId** для конкретного графика.

Например график **Carbon - agents localdomain** имеет следующую ссылку:

http://192.168.231.6:3000/dashboard/db/bot-testing-dashboard?refresh=1m&panelId=1&fullscreen&orgId=1

В ней видно, что его **panelId=1** 

и это указано в соответствующем блоке **main.py**:

```python
dashboard = 'bot-testing-dashboard'
if message.text == 'Carbon agents localdomain':
    panelId = ('1')
```

Ссылки:
1. https://github.com/eternnoir/pyTelegramBotAPI
2. https://grafana.com/docs/http_api/auth/
